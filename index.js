// Generated by CoffeeScript 1.11.1

/*
@fileOverview ./index.coffee
@description
Grammuelle.
 */

(function() {
  var Grammuelle, Lexer, Operation, P, _, __fs__, __q__, async, capture_module, colors, g, log, open;

  __fs__ = require('fs');

  __q__ = require('promise-defer');

  P = require('promise');

  log = console.log;

  _ = require('lodash');

  async = require('async');

  colors = require('colors');


  /*
  @internal
  @name int
   */

  String.prototype.int = function() {
    return parseInt(this, 10);
  };


  /*
  @internal
  @name capitalize
   */

  String.prototype.capitalize = function() {
    var capitalizedFirstCharOfName, firstCharRemoved;
    capitalizedFirstCharOfName = this.split('').reverse().pop().toUpperCase();
    firstCharRemoved = this.slice(1, this.length);
    return capitalizedFirstCharOfName + firstCharRemoved;
  };


  /*
  @name open
  @description
  Open a stylebook.
   */

  open = function(f) {
    var defer;
    if (f == null) {
      f = './__test__.scss';
    }
    defer = __q__();
    __fs__.readFile(f, 'utf-8', function(error, data) {
      defer.resolve(data);
    });
    return defer.promise;
  };


  /*
  @name capture_module
  @description
  Look for Do(...)
   */

  capture_module = function(view) {
    var m;
    if (m = view.match(/(\@include\s*(.*)\(\')(.*)(\')/)) {
      view = ("module[" + m.index + "]__") + m[3];
    }
    return view;
  };


  /*
  @class
  @name Lexer
  @description
  Lexer Contract Loader.
   */

  Lexer = (function() {
    function Lexer(parsers) {
      this.parsers = parsers;
    }

    Lexer.prototype.contract = function(loaded, parser) {
      if (parser) {
        return parser(loaded || '');
      } else {
        return loaded;
      }
    };

    Lexer.prototype.parse = function(content) {
      var c, list, view;
      c = content.split("\n");
      return list = (function() {
        var j, len, results;
        results = [];
        for (j = 0, len = c.length; j < len; j++) {
          view = c[j];
          results.push(this.ready(view));
        }
        return results;
      }).call(this);
    };

    Lexer.prototype.ready = function(view) {
      var p;
      return p = this.parsers.reduce(this.contract, view);
    };

    return Lexer;

  })();


  /*
  @class
  @name Operation
   */

  Operation = (function() {
    function Operation(op) {
      this.op = op;
      this.op;
    }

    return Operation;

  })();


  /*
  @class
  @name Grammuelle
   */

  Grammuelle = (function() {
    var p;

    p = new Lexer([capture_module]);

    function Grammuelle() {}

    Grammuelle.prototype.generate = function() {
      var defer, el;
      defer = __q__();
      el = [];
      open().then(function(data) {
        var oldgrams, parseMap, psb;
        psb = p.parse(data);
        parseMap = _.filter(_.map(psb, function(d) {
          var c, classPosition, dirtyName, h, newComponentName, newModuleName, opname, privateClassPosition;
          opname = null;
          if (c = d.match(/module\[([0-9])\]\_\_(.*)/)) {
            h = c[1].int();
            classPosition = 0;
            privateClassPosition = 2;
            dirtyName = c[2];
            if (h === classPosition) {
              newModuleName = dirtyName && dirtyName.capitalize();
              opname = newModuleName;
            }
            if (h === privateClassPosition) {
              newComponentName = dirtyName && dirtyName.toLowerCase();
              opname = newComponentName;
            }
          }
          return {
            opname: opname,
            oppos: h
          };
        }));
        oldgrams = null;
        return open('./stylebook.grams').then(function(grams) {
          var obj, oldname, z;
          z = _.remove(parseMap, function(a) {
            return a.opname;
          });
          oldname = null;
          obj = {};
          _.each(z, function(o) {
            if (o.hasOwnProperty('oppos')) {
              if (o.oppos === 0) {
                obj[o.opname] = {};
                return oldname = o.opname;
              } else {
                return obj[oldname][o.opname] = {};
              }
            }
          });
          _.each(obj, function(a, i) {
            var INIT, INIT_SCOPE, INNER, INNER_SCOPE, NAME, NAME_SCOPE, ankh, init, inner, key, named, sub;
            key = i;
            sub = a;
            NAME = /%%SCSS_NAME%%/;
            NAME_SCOPE = /%%SCSS_NAME%%/g;
            named = grams.match(NAME);
            ankh = grams.replace(NAME_SCOPE, key);
            INNER = /%%SCSS_INNER%%/;
            INNER_SCOPE = /%%SCSS_INNER%%/g;
            inner = grams.match(INNER);
            ankh = ankh.replace(INNER_SCOPE, _.keys(a).join('').capitalize());
            INIT = /%%SCSS_INIT_INNER%%/;
            INIT_SCOPE = /%%SCSS_INIT_INNER%%/g;
            init = grams.match(INIT);
            ankh = ankh.replace(INIT_SCOPE, _.keys(a));
            return el.push({
              filename: key,
              schema: ankh
            });
          });
          return defer.resolve(el);
        });
      });
      return defer.promise;
    };

    return Grammuelle;

  })();

  g = new Grammuelle;

  g.generate().then(function(output) {
    var ext, pathbase;
    pathbase = './';
    ext = '.coffee';
    return _.each(output, function(o, i) {
      var filepath, inputdata;
      filepath = pathbase + o.filename + ext;
      inputdata = o.schema;
      return __fs__.writeFile(filepath, inputdata, function(error) {
        if (error != null) {
          return log(error);
        } else {
          return log(("Saved " + o.filename + ".coffee").rainbow);
        }
      });
    });
  });

}).call(this);
